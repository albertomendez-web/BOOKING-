<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cache Reservas ‚Äî Homity Holidays</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#ffffff;--bg2:#f8f9fb;
  --surface:#ffffff;--surface2:#f3f4f7;--surface3:#ebedf2;
  --border:#e2e5ec;--border2:#d0d4de;--border-glow:#b8bfce;
  --text:#1a1f2e;--text2:#4a5568;--text3:#8492a6;--text4:#a0aec0;
  --accent:#0ea37f;--accent2:#0c8b6c;--accent-light:#e6f7f3;--accent-glow:rgba(14,163,127,.12);--accent-glow2:rgba(14,163,127,.05);
  --ok:#0ea37f;--ok-bg:#e6f7f3;--ok-border:#b2e5d8;
  --cancel:#dc3545;--cancel-bg:#fdf0f1;--cancel-border:#f5c6cb;
  --warn:#e67e22;--warn-bg:#fef6ec;--warn-border:#f5d9a8;
  --purple:#7c3aed;--purple-bg:#f3effb;
  --blue:#2563eb;--blue-bg:#eff4ff;
  --font:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace;
  --r:10px;--r-lg:14px;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 0 1px rgba(0,0,0,.08);
  --shadow-lg:0 4px 16px rgba(0,0,0,.08),0 0 1px rgba(0,0,0,.1);
}
html{font-size:14px;scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg2);color:var(--text);min-height:100vh;overflow-x:hidden}

/* LOADER */
#loader{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .4s}
#loader.hide{opacity:0;pointer-events:none}
.spin{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader p{color:var(--text3);font-size:.9rem}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.92);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);padding:0 48px;height:60px;display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:14px}
.logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--blue));
  display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;font-size:.82rem;color:#fff;box-shadow:0 2px 10px var(--accent-glow)}
.header h1{font-size:1.1rem;font-weight:600;letter-spacing:-.3px}
.header h1 span{color:var(--text3);font-weight:300;margin-left:4px}
.header-right{display:flex;align-items:center;gap:12px}
.live-badge{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);
  padding:5px 14px;border-radius:20px;font-size:.73rem;color:var(--text2);font-family:var(--mono)}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--ok);box-shadow:0 0 6px rgba(14,163,127,.5);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.content{max-width:1640px;margin:0 auto;padding:24px 48px 64px}

/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;margin-bottom:24px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 22px;box-shadow:var(--shadow);transition:all .3s}
.kpi:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
.kpi-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.95rem;margin-bottom:10px}
.kpi-icon.i-total{background:var(--blue-bg);color:var(--blue)}
.kpi-icon.i-ok{background:var(--ok-bg);color:var(--ok)}
.kpi-icon.i-cancel{background:var(--cancel-bg);color:var(--cancel)}
.kpi-icon.i-money{background:var(--accent-light);color:var(--accent)}
.kpi-icon.i-comm{background:var(--purple-bg);color:var(--purple)}
.kpi-icon.i-nights{background:var(--warn-bg);color:var(--warn)}
.kpi-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1.8px;color:var(--text3);margin-bottom:5px;font-weight:600}
.kpi-val{font-size:1.5rem;font-weight:700;font-family:var(--mono);letter-spacing:-1px;line-height:1.1}
.kpi-val.c-ok{color:var(--ok)}.kpi-val.c-cancel{color:var(--cancel)}
.kpi-sub{font-size:.7rem;color:var(--text4);margin-top:5px}

/* CHART ROW */
.analytics-row{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--shadow)}
.card-head{padding:16px 22px 0;display:flex;justify-content:space-between}
.card-title{font-size:.88rem;font-weight:600}
.card-sub{font-size:.7rem;color:var(--text4)}
.chart-area{padding:14px 22px 18px;height:220px}
canvas{width:100%!important;height:100%!important}
.prop-list{padding:6px 18px 18px}
.prop-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--surface2)}
.prop-item:last-child{border-bottom:none}
.prop-rank{width:22px;height:22px;border-radius:6px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:.63rem;font-family:var(--mono);font-weight:600;color:var(--text3);flex-shrink:0}
.prop-rank.top{background:var(--accent-light);color:var(--accent)}
.prop-info{flex:1;min-width:0}
.prop-name{font-size:.78rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prop-bar{height:4px;background:var(--surface3);border-radius:2px;margin-top:4px;overflow:hidden}
.prop-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--blue));transition:width .8s ease}
.prop-count{font-family:var(--mono);font-size:.73rem;color:var(--text2);font-weight:500;flex-shrink:0}

/* FILTERS */
.filters-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:14px 22px;display:flex;flex-wrap:wrap;gap:14px;align-items:end;margin-bottom:4px;box-shadow:var(--shadow)}
.filter-item{display:flex;flex-direction:column;gap:3px}
.filter-label{font-size:.58rem;text-transform:uppercase;letter-spacing:1.6px;color:var(--text4);font-weight:600}
select,.search-input{background:var(--bg2);border:1px solid var(--border);color:var(--text);
  padding:7px 12px;border-radius:7px;font-family:var(--font);font-size:.82rem;outline:none;transition:all .25s}
select:focus,.search-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
select{cursor:pointer;min-width:130px}
.search-input{width:250px}
.filter-spacer{flex:1}
.filter-actions{display:flex;gap:8px;align-items:end}
.btn-f{padding:7px 16px;border-radius:7px;border:1px solid var(--border);background:var(--surface);
  color:var(--text2);font-family:var(--font);font-size:.78rem;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.btn-f:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.btn-f.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.btn-f.primary:hover{background:var(--accent2)}

/* TABLE */
.table-meta{display:flex;align-items:center;justify-content:space-between;padding:12px 0 6px;flex-wrap:wrap;gap:10px}
.table-count{font-size:.76rem;color:var(--text3);font-family:var(--mono)}
.table-controls{display:flex;align-items:center;gap:10px}
.table-controls label{font-size:.68rem;color:var(--text4);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.ps-select{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:4px 10px;border-radius:6px;font-family:var(--mono);font-size:.78rem;cursor:pointer;outline:none}
.ps-select:focus{border-color:var(--accent)}
.table-container{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--shadow)}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead th{background:var(--surface2);color:var(--text3);font-weight:600;text-transform:uppercase;
  font-size:.64rem;letter-spacing:1.1px;padding:12px 11px;text-align:left;
  border-bottom:2px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;transition:color .2s;position:sticky;top:0;z-index:5}
thead th:hover{color:var(--accent)}
thead th.asc::after{content:' ‚Üë';color:var(--accent);font-weight:700}
thead th.desc::after{content:' ‚Üì';color:var(--accent);font-weight:700}
tbody tr{transition:background .12s;border-bottom:1px solid var(--surface2)}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--accent-glow2)}
tbody tr:nth-child(even){background:var(--bg2)}
tbody tr:nth-child(even):hover{background:var(--accent-glow2)}
tbody td{padding:10px 11px;white-space:nowrap;max-width:260px;overflow:hidden;text-overflow:ellipsis}
td.mono{font-family:var(--mono);font-size:.76rem;text-align:right;color:var(--text2)}
td.name{font-weight:500;color:var(--text)}
td.prop{color:var(--text2);font-size:.76rem}
td.dim{color:var(--text3);font-size:.78rem}
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 11px;border-radius:20px;font-size:.68rem;font-weight:600;letter-spacing:.3px}
.badge::before{content:'';width:5px;height:5px;border-radius:50%}
.badge-ok{background:var(--ok-bg);color:var(--ok);border:1px solid var(--ok-border)}.badge-ok::before{background:var(--ok)}
.badge-cancel{background:var(--cancel-bg);color:var(--cancel);border:1px solid var(--cancel-border)}.badge-cancel::before{background:var(--cancel)}
.badge-noshow{background:var(--warn-bg);color:var(--warn);border:1px solid var(--warn-border)}.badge-noshow::before{background:var(--warn)}
.badge-other{background:var(--purple-bg);color:var(--purple);border:1px solid rgba(124,58,237,.2)}.badge-other::before{background:var(--purple)}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:center;gap:5px;padding:20px 0 12px}
.pg{width:32px;height:32px;border-radius:7px;background:var(--surface);border:1px solid var(--border);
  color:var(--text3);font-family:var(--mono);font-size:.76rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.pg:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.pg.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700;box-shadow:0 2px 8px var(--accent-glow)}
.pg.nav{width:auto;padding:0 14px;font-family:var(--font);font-size:.76rem;font-weight:500}
.pg-dots{color:var(--text4);font-family:var(--mono);padding:0 3px;font-size:.75rem}

/* ERROR */
.error-box{text-align:center;padding:60px 40px;color:var(--text3)}
.error-box h2{color:var(--cancel);font-size:1.2rem;margin-bottom:10px}
.error-box a{color:var(--accent)}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

@media(max-width:1200px){.kpi-row{grid-template-columns:repeat(3,1fr)}.analytics-row{grid-template-columns:1fr}}
@media(max-width:768px){.header,.content{padding-left:20px;padding-right:20px}.kpi-row{grid-template-columns:repeat(2,1fr);gap:10px}.search-input{width:100%}}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>Cargando reservas desde Google Sheets‚Ä¶</p></div>

<header class="header">
  <div class="header-left">
    <div class="logo">CR</div>
    <h1>Cache Reservas<span>¬∑ Homity Holidays Booking</span></h1>
  </div>
  <div class="header-right">
    <div class="live-badge"><span class="live-dot"></span><span id="liveText">Conectando‚Ä¶</span></div>
  </div>
</header>

<div class="content">
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-icon i-total">üìä</div><div class="kpi-label">Total Reservas</div><div class="kpi-val" id="k0">‚Äî</div><div class="kpi-sub" id="ks0"></div></div>
    <div class="kpi"><div class="kpi-icon i-ok">‚úì</div><div class="kpi-label">Reservas OK</div><div class="kpi-val c-ok" id="k1">‚Äî</div><div class="kpi-sub" id="ks1"></div></div>
    <div class="kpi"><div class="kpi-icon i-cancel">‚úï</div><div class="kpi-label">Canceladas</div><div class="kpi-val c-cancel" id="k2">‚Äî</div><div class="kpi-sub" id="ks2"></div></div>
    <div class="kpi"><div class="kpi-icon i-money">‚Ç¨</div><div class="kpi-label">Importe Total</div><div class="kpi-val" id="k3">‚Äî</div><div class="kpi-sub" id="ks3"></div></div>
    <div class="kpi"><div class="kpi-icon i-comm">%</div><div class="kpi-label">Comisi√≥n Total</div><div class="kpi-val" id="k4">‚Äî</div><div class="kpi-sub" id="ks4"></div></div>
    <div class="kpi"><div class="kpi-icon i-nights">‚òΩ</div><div class="kpi-label">Noches Totales</div><div class="kpi-val" id="k5">‚Äî</div><div class="kpi-sub" id="ks5"></div></div>
  </div>

  <div class="analytics-row">
    <div class="card">
      <div class="card-head"><div><div class="card-title">Reservas por Periodo</div><div class="card-sub">Evoluci√≥n mensual</div></div></div>
      <div class="chart-area"><canvas id="chart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-head"><div><div class="card-title">Top Propiedades</div><div class="card-sub">Por volumen de reservas</div></div></div>
      <div class="prop-list" id="propList"></div>
    </div>
  </div>

  <div class="filters-bar">
    <div class="filter-item"><span class="filter-label">Estado</span><select id="fSt"><option value="">Todos</option></select></div>
    <div class="filter-item"><span class="filter-label">Propiedad</span><select id="fPr"><option value="">Todas</option></select></div>
    <div class="filter-item"><span class="filter-label">Periodo</span><select id="fPe"><option value="">Todos</option></select></div>
    <div class="filter-item"><span class="filter-label">Tipo</span><select id="fTy"><option value="">Todos</option></select></div>
    <div class="filter-item"><span class="filter-label">Buscar</span><input class="search-input" type="text" id="searchBox" placeholder="Nombre, n¬∫ reserva, propiedad‚Ä¶"></div>
    <div class="filter-spacer"></div>
    <div class="filter-actions">
      <button class="btn-f" onclick="resetFilters()">‚úï Limpiar</button>
      <button class="btn-f primary" onclick="exportCSV()">‚Üì CSV</button>
    </div>
  </div>

  <div class="table-meta">
    <span class="table-count" id="tableCount"></span>
    <div class="table-controls">
      <label>Filas</label>
      <select class="ps-select" id="psSelect">
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="500">500</option>
        <option value="0">Todas</option>
      </select>
      <span class="table-count" style="margin-left:6px">Click cabecera = ordenar</span>
    </div>
  </div>

  <div class="table-container">
    <div class="table-scroll">
      <table><thead id="thead"><tr></tr></thead><tbody id="tbody"></tbody></table>
    </div>
  </div>

  <div class="pagination" id="pag"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
const SHEET_ID='1hi4dWvoqiCD-3k9Yv6sH5KChaYRdRW_dSdBwb9Ryvhw', GID='1035619300';

// Columns to display: [srcIndex, label, type]
// types: m=mono/num, $=money, n=name, p=property, s=status, d=dim
const DC=[
  [0,'Reserva','m'],[3,'Llegada','d'],[4,'Salida','d'],[6,'Hu√©sped','n'],
  [19,'Propiedad','p'],[20,'Ciudad','d'],[7,'Hab.','m'],[8,'Pers.','m'],[9,'Noches','m'],
  [12,'Importe','$'],[13,'Comisi√≥n','$'],[15,'Estado','s'],[17,'Moneda','d'],[23,'Periodo','d'],[24,'Tipo','d']
];

let allRows=[], filtered=[], PAGE_SIZE=100, page=0, sCol=-1, sDir=1, chartInst=null;

// ‚ïê‚ïê‚ïê LOAD FROM GOOGLE SHEETS ‚ïê‚ïê‚ïê
function load(){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}&headers=1`;
  fetch(url,{credentials:'include'})
    .then(r=>{if(!r.ok)throw new Error(r.status);return r.text()})
    .then(txt=>{
      const j=txt.replace(/^[\s\S]*?google\.visualization\.Query\.setResponse\(/,'').replace(/\);?\s*$/,'');
      process(JSON.parse(j));
    })
    .catch(()=>{
      // JSONP fallback
      window.__cb=function(d){process(d)};
      const s=document.createElement('script');
      s.src=url.replace('tqx=out:json','tqx=out:json;responseHandler:__cb');
      s.onerror=()=>{
        document.getElementById('loader').innerHTML='<div class="error-box"><h2>‚ö† No se pudo conectar</h2><p>La hoja debe estar compartida como "Cualquier persona con el enlace"</p><p style="margin-top:10px"><a href="https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/edit?gid='+GID+'" target="_blank">Abrir en Google Sheets ‚Üó</a></p></div>';
      };
      document.body.appendChild(s);
    });
}
// Also handle default gviz wrapper
if(!window.google)window.google={};
if(!window.google.visualization)window.google.visualization={};
if(!window.google.visualization.Query)window.google.visualization.Query={};
window.google.visualization.Query.setResponse=function(d){process(d)};

function process(data){
  const cols=data.table.cols, types=cols.map(c=>c.type);
  allRows=data.table.rows.map(row=>
    row.c.map((cell,i)=>{
      if(!cell)return '';
      if(types[i]==='date'||types[i]==='datetime')return cell.f||'';
      return cell.v!=null?cell.v:'';
    })
  );
  initUI();
  document.getElementById('loader').classList.add('hide');
  document.getElementById('liveText').textContent=allRows.length.toLocaleString('es')+' registros';
}

function initUI(){
  populateFilters();
  buildHead();
  buildChart();
  buildProps();
  applyFilters();
  document.getElementById('psSelect').addEventListener('change',function(){
    PAGE_SIZE=parseInt(this.value)||0; page=0; renderTable();
  });
}

// ‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê
function populateFilters(){
  const sets={fSt:15,fPr:19,fPe:23,fTy:24};
  Object.entries(sets).forEach(([id,ci])=>{
    const vals=[...new Set(allRows.map(r=>String(r[ci]||'')).filter(Boolean))].sort();
    const sel=document.getElementById(id);
    vals.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v.length>45?v.substring(0,42)+'‚Ä¶':v;sel.appendChild(o)});
    sel.addEventListener('change',()=>{page=0;applyFilters()});
  });
  document.getElementById('searchBox').addEventListener('input',debounce(()=>{page=0;applyFilters()},200));
}

function applyFilters(){
  const st=document.getElementById('fSt').value,pr=document.getElementById('fPr').value,
        pe=document.getElementById('fPe').value,ty=document.getElementById('fTy').value,
        q=document.getElementById('searchBox').value.toLowerCase().trim();
  filtered=allRows.filter(r=>{
    if(st&&String(r[15])!==st)return false;
    if(pr&&String(r[19])!==pr)return false;
    if(pe&&String(r[23])!==pe)return false;
    if(ty&&String(r[24])!==ty)return false;
    if(q&&[r[0],r[5],r[6],r[19],r[20],r[23]].join(' ').toLowerCase().indexOf(q)===-1)return false;
    return true;
  });
  if(sCol>=0)doSort();
  updateKPIs();
  renderTable();
}

function resetFilters(){
  ['fSt','fPr','fPe','fTy'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('searchBox').value='';page=0;applyFilters();
}

// ‚ïê‚ïê‚ïê KPIs ‚ïê‚ïê‚ïê
function updateKPIs(){
  const n=filtered.length;
  const ok=filtered.filter(r=>String(r[15])==='OK').length;
  const canc=filtered.filter(r=>{const s=String(r[15]).toUpperCase();return s==='CANCELLED'||s.includes('CANCELLATION')}).length;
  const ns=filtered.filter(r=>{const s=String(r[15]).toUpperCase();return s==='NO_SHOW'||s.includes('NO SHOW')}).length;
  const amt=filtered.reduce((s,r)=>s+(parseFloat(r[12])||0),0);
  const com=filtered.reduce((s,r)=>s+(parseFloat(r[13])||0),0);
  const nts=filtered.reduce((s,r)=>s+(parseInt(r[9])||0),0);

  $('k0',n.toLocaleString('es'));$('ks0',`de ${allRows.length.toLocaleString('es')} totales`);
  $('k1',ok.toLocaleString('es'));$('ks1',n?(ok/n*100).toFixed(1)+'% del filtro':'');
  $('k2',canc.toLocaleString('es'));$('ks2',ns?`+ ${ns} No-Show`:'');
  $('k3',fmt(amt)+' ‚Ç¨');$('ks3',n?'Media: '+fmt(amt/n)+' ‚Ç¨/reserva':'');
  $('k4',fmt(com)+' ‚Ç¨');$('ks4',amt?(com/amt*100).toFixed(1)+'% del importe':'');
  $('k5',nts.toLocaleString('es'));$('ks5',n?'Media: '+(nts/n).toFixed(1)+' noches/reserva':'');
}

// ‚ïê‚ïê‚ïê TABLE ‚ïê‚ïê‚ïê
function buildHead(){
  const tr=document.querySelector('#thead tr');
  DC.forEach((c,i)=>{const th=document.createElement('th');th.textContent=c[1];th.onclick=()=>sortBy(i);th.dataset.i=i;tr.appendChild(th)});
}

function sortBy(i){
  const th=document.querySelector(`th[data-i="${i}"]`),wasAsc=th.classList.contains('asc');
  document.querySelectorAll('th').forEach(t=>t.classList.remove('asc','desc'));
  sCol=i;sDir=wasAsc?-1:1;
  th.classList.add(sDir===1?'asc':'desc');
  doSort();page=0;renderTable();
}

function doSort(){
  const ci=DC[sCol][0],tp=DC[sCol][2],isNum=(tp==='m'||tp==='$');
  filtered.sort((a,b)=>{let va=a[ci],vb=b[ci];if(isNum){va=parseFloat(va)||0;vb=parseFloat(vb)||0}else{va=String(va).toLowerCase();vb=String(vb).toLowerCase()}return(va<vb?-1:va>vb?1:0)*sDir});
}

function renderTable(){
  const ps=PAGE_SIZE||filtered.length;
  const s=page*ps,e=Math.min(s+ps,filtered.length),rows=filtered.slice(s,e);
  let h='';
  rows.forEach(row=>{
    h+='<tr>';
    DC.forEach(c=>{
      const v=row[c[0]],tp=c[2];
      if(tp==='s')h+=`<td>${badge(v)}</td>`;
      else if(tp==='$')h+=`<td class="mono">${v?parseFloat(v).toLocaleString('es',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨':'‚Äî'}</td>`;
      else if(tp==='m')h+=`<td class="mono">${v!==''&&v!=null?v:'‚Äî'}</td>`;
      else if(tp==='n')h+=`<td class="name" title="${esc(v)}">${esc(v)||'‚Äî'}</td>`;
      else if(tp==='p'){const sh=String(v||'').replace('Homity Holidays - ','');h+=`<td class="prop" title="${esc(v)}">${esc(sh)||'‚Äî'}</td>`}
      else h+=`<td class="dim">${esc(v)||'‚Äî'}</td>`;
    });
    h+='</tr>';
  });
  document.getElementById('tbody').innerHTML=h;
  document.getElementById('tableCount').textContent=filtered.length?`${s+1}‚Äì${e} de ${filtered.length.toLocaleString('es')} reservas`:'Sin resultados';
  renderPag();
}

function badge(v){
  const u=String(v||'').toUpperCase();
  if(u==='OK')return'<span class="badge badge-ok">OK</span>';
  if(u==='CANCELLED'||u.includes('CANCELLATION'))return'<span class="badge badge-cancel">Cancelada</span>';
  if(u==='NO_SHOW'||u.includes('NO SHOW'))return'<span class="badge badge-noshow">No-Show</span>';
  if(u.includes('CHARGEABLE'))return'<span class="badge badge-other">Chargeable</span>';
  if(v)return`<span class="badge badge-other">${esc(v)}</span>`;
  return'<span class="badge badge-other">‚Äî</span>';
}

// ‚ïê‚ïê‚ïê PAGINATION ‚ïê‚ïê‚ïê
function renderPag(){
  const ps=PAGE_SIZE||filtered.length,total=Math.ceil(filtered.length/ps),el=document.getElementById('pag');
  if(total<=1){el.innerHTML='';return}
  let h='';
  if(page>0)h+=`<button class="pg nav" onclick="gp(${page-1})">‚Äπ Anterior</button>`;
  const s=Math.max(0,page-3),e=Math.min(total-1,page+3);
  if(s>0){h+=`<button class="pg" onclick="gp(0)">1</button>`;if(s>1)h+='<span class="pg-dots">‚Ä¶</span>'}
  for(let p=s;p<=e;p++)h+=`<button class="pg${p===page?' active':''}" onclick="gp(${p})">${p+1}</button>`;
  if(e<total-1){if(e<total-2)h+='<span class="pg-dots">‚Ä¶</span>';h+=`<button class="pg" onclick="gp(${total-1})">${total}</button>`}
  if(page<total-1)h+=`<button class="pg nav" onclick="gp(${page+1})">Siguiente ‚Ä∫</button>`;
  el.innerHTML=h;
}
function gp(p){page=p;renderTable();document.querySelector('.table-container').scrollIntoView({behavior:'smooth',block:'start'})}

// ‚ïê‚ïê‚ïê CHART ‚ïê‚ïê‚ïê
function buildChart(){
  const byP={};
  allRows.forEach(r=>{
    const p=String(r[23]||'');if(!p)return;
    if(!byP[p])byP[p]={n:0,amt:0};
    byP[p].n++;byP[p].amt+=(parseFloat(r[12])||0);
  });
  const sorted=Object.entries(byP).sort((a,b)=>a[0].localeCompare(b[0]));
  const labels=sorted.map(d=>d[0]),counts=sorted.map(d=>d[1].n),amts=sorted.map(d=>Math.round(d[1].amt));
  const yearC={'2021':'#93c5fd','2022':'#a78bfa','2023':'#6ee7b7','2024':'#0ea37f','2025':'#f59e0b'};

  chartInst=new Chart(document.getElementById('chart').getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{
      label:'Reservas',data:counts,
      backgroundColor:labels.map(l=>yearC[l.substring(0,4)]||'#ccc'),
      borderRadius:3,borderSkipped:false
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'#1a1f2e',titleColor:'#fff',bodyColor:'#a0aec0',borderColor:'#d0d4de',borderWidth:1,padding:12,cornerRadius:8,
        callbacks:{label:c=>`${c.parsed.y} reservas`,afterLabel:c=>`‚Ç¨ ${amts[c.dataIndex].toLocaleString('es')}`}
      }},
      scales:{
        x:{grid:{display:false},ticks:{color:'#a0aec0',font:{family:'JetBrains Mono',size:9},maxRotation:90,minRotation:45}},
        y:{grid:{color:'#e2e5ec40'},ticks:{color:'#a0aec0',font:{family:'JetBrains Mono',size:10}}}
      }
    }
  });
}

// ‚ïê‚ïê‚ïê TOP PROPERTIES ‚ïê‚ïê‚ïê
function buildProps(){
  const cnt={};
  allRows.forEach(r=>{const p=String(r[19]||'');if(p)cnt[p]=(cnt[p]||0)+1});
  const top=Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const mx=top[0]?top[0][1]:1,el=document.getElementById('propList');
  top.forEach((p,i)=>{
    const short=p[0].replace('Homity Holidays - ','').replace('Exclusive ','');
    el.innerHTML+=`<div class="prop-item"><div class="prop-rank${i<3?' top':''}">${i+1}</div><div class="prop-info"><div class="prop-name" title="${esc(p[0])}">${esc(short)}</div><div class="prop-bar"><div class="prop-bar-fill" style="width:${(p[1]/mx*100).toFixed(0)}%"></div></div></div><div class="prop-count">${p[1].toLocaleString('es')}</div></div>`;
  });
}

// ‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê
function exportCSV(){
  const h=DC.map(c=>c[1]),rows=[h.join(';')];
  filtered.forEach(r=>rows.push(DC.map(c=>'"'+String(r[c[0]]??'').replace(/"/g,'""')+'"').join(';')));
  const b=new Blob(['\uFEFF'+rows.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='cache_reservas_'+new Date().toISOString().substring(0,10)+'.csv';a.click();
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function $(id,v){document.getElementById(id).textContent=v}
function esc(v){return String(v||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;')}
function fmt(n){return n.toLocaleString('es',{minimumFractionDigits:2,maximumFractionDigits:2})}
function debounce(fn,ms){let t;return function(){clearTimeout(t);t=setTimeout(fn,ms)}}

document.addEventListener('DOMContentLoaded',load);
</script>
</body>
</html>
