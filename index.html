<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cache Reservas — Homity Holidays</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0c0f14;--surface:#161a22;--surface2:#1e232d;--surface3:#262c38;
  --border:#2a3040;--border-light:#3a4258;
  --text:#e8eaf0;--text-muted:#8892a6;--text-dim:#5a6478;
  --accent:#4ecdc4;--accent-glow:#4ecdc433;--accent-dark:#3aa89f;
  --ok:#34d399;--cancelled:#f87171;--no-show:#fbbf24;--chargeable:#a78bfa;
  --font:'DM Sans',sans-serif;--mono:'Space Mono',monospace;
  --radius:10px;--radius-lg:16px;
}
html{font-size:14px;scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--accent);text-decoration:none}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;transition:opacity .5s}
#loader.hidden{opacity:0;pointer-events:none}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader p{color:var(--text-muted);font-size:.95rem;letter-spacing:.5px}

/* HEADER */
.header{padding:28px 40px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100;background:var(--bg)ee}
.header-left{display:flex;align-items:center;gap:16px}
.logo{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),#6366f1);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;color:#fff;letter-spacing:-1px;box-shadow:0 4px 20px var(--accent-glow)}
.header h1{font-size:1.4rem;font-weight:700;letter-spacing:-.5px}
.header h1 span{color:var(--accent);font-weight:300}
.header-right{display:flex;align-items:center;gap:12px}
.header-badge{background:var(--surface2);border:1px solid var(--border);padding:6px 14px;border-radius:20px;font-size:.78rem;color:var(--text-muted);font-family:var(--mono);display:flex;align-items:center;gap:6px}
.header-badge .dot{width:7px;height:7px;background:var(--ok);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* KPI STRIP */
.kpi-strip{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;padding:24px 40px;border-bottom:1px solid var(--border)}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px 22px;position:relative;overflow:hidden;transition:border-color .3s,transform .2s}
.kpi:hover{border-color:var(--accent);transform:translateY(-2px)}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .3s}
.kpi:hover::before{opacity:1}
.kpi-label{font-size:.72rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:8px;font-weight:500}
.kpi-value{font-size:1.7rem;font-weight:700;letter-spacing:-1px;font-family:var(--mono)}
.kpi-sub{font-size:.75rem;color:var(--text-muted);margin-top:4px}
.kpi-value.ok{color:var(--ok)}.kpi-value.cancelled{color:var(--cancelled)}

/* FILTERS */
.filters{padding:20px 40px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;border-bottom:1px solid var(--border)}
.filter-group{display:flex;align-items:center;gap:6px}
.filter-group label{font-size:.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:500;white-space:nowrap}
select,input[type="text"],input[type="month"]{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:8px;font-family:var(--font);font-size:.85rem;outline:none;transition:border-color .2s}
select:focus,input:focus{border-color:var(--accent)}
select{cursor:pointer;max-width:220px}
input[type="text"]{width:240px}
input[type="month"]{width:160px}
.btn{padding:8px 18px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:var(--font);font-size:.82rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn-accent{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:600}
.btn-accent:hover{background:var(--accent-dark);color:#fff}
.filter-spacer{flex:1}

/* TABLE */
.table-wrap{padding:0 40px 20px;overflow-x:auto;margin-top:4px}
.table-info{padding:12px 40px 0;display:flex;align-items:center;justify-content:space-between}
.table-count{font-size:.8rem;color:var(--text-muted);font-family:var(--mono)}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:.82rem}
thead th{position:sticky;top:66px;background:var(--surface);border-bottom:2px solid var(--accent);color:var(--text-muted);font-weight:600;text-transform:uppercase;font-size:.68rem;letter-spacing:1px;padding:12px 10px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none;z-index:10;transition:color .2s}
thead th:hover{color:var(--accent)}
thead th.sorted-asc::after{content:' ▲';color:var(--accent);font-size:.6rem}
thead th.sorted-desc::after{content:' ▼';color:var(--accent);font-size:.6rem}
tbody tr{transition:background .15s}
tbody tr:hover{background:var(--surface2)}
tbody tr:nth-child(even){background:var(--surface)11}
tbody td{padding:9px 10px;border-bottom:1px solid var(--border);white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis}
td.num{text-align:right;font-family:var(--mono);font-size:.8rem}
.status-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;letter-spacing:.3px}
.status-ok{background:#34d39920;color:#34d399;border:1px solid #34d39940}
.status-cancelled{background:#f8717120;color:#f87171;border:1px solid #f8717140}
.status-no_show{background:#fbbf2420;color:#fbbf24;border:1px solid #fbbf2440}
.status-chargeable{background:#a78bfa20;color:#a78bfa;border:1px solid #a78bfa40}

/* PAGINATION */
.pagination{padding:16px 40px 32px;display:flex;align-items:center;justify-content:center;gap:8px}
.page-btn{background:var(--surface);border:1px solid var(--border);color:var(--text-muted);width:36px;height:36px;border-radius:8px;cursor:pointer;font-family:var(--mono);font-size:.8rem;display:flex;align-items:center;justify-content:center;transition:all .2s}
.page-btn:hover{border-color:var(--accent);color:var(--accent)}
.page-btn.active{background:var(--accent);border-color:var(--accent);color:var(--bg);font-weight:700}
.page-btn.nav{width:auto;padding:0 14px;font-family:var(--font)}
.page-info{font-size:.78rem;color:var(--text-dim);margin:0 12px;font-family:var(--mono)}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border-light)}

/* RESPONSIVE */
@media(max-width:768px){
  .header,.kpi-strip,.filters,.table-info,.table-wrap,.pagination{padding-left:16px;padding-right:16px}
  .kpi-strip{grid-template-columns:repeat(2,1fr);gap:10px}
  .filters{gap:8px}
  input[type="text"]{width:100%}
  .header h1{font-size:1.1rem}
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="spinner"></div>
  <p>Cargando reservas desde Google Sheets…</p>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div class="logo">HR</div>
    <h1>Cache Reservas <span>· Homity Holidays</span></h1>
  </div>
  <div class="header-right">
    <div class="header-badge"><span class="dot"></span> <span id="liveStatus">Conectando…</span></div>
  </div>
</div>

<!-- KPIs -->
<div class="kpi-strip">
  <div class="kpi"><div class="kpi-label">Total Reservas</div><div class="kpi-value" id="kpiTotal">—</div><div class="kpi-sub" id="kpiTotalSub"></div></div>
  <div class="kpi"><div class="kpi-label">Reservas OK</div><div class="kpi-value ok" id="kpiOk">—</div><div class="kpi-sub" id="kpiOkSub"></div></div>
  <div class="kpi"><div class="kpi-label">Canceladas</div><div class="kpi-value cancelled" id="kpiCancel">—</div><div class="kpi-sub" id="kpiCancelSub"></div></div>
  <div class="kpi"><div class="kpi-label">Importe Total (€)</div><div class="kpi-value" id="kpiFinal">—</div><div class="kpi-sub" id="kpiFinalSub"></div></div>
  <div class="kpi"><div class="kpi-label">Comisión Total (€)</div><div class="kpi-value" id="kpiComm">—</div><div class="kpi-sub" id="kpiCommSub"></div></div>
  <div class="kpi"><div class="kpi-label">Noches Totales</div><div class="kpi-value" id="kpiNights">—</div><div class="kpi-sub" id="kpiNightsSub"></div></div>
</div>

<!-- FILTERS -->
<div class="filters">
  <div class="filter-group">
    <label>Estado</label>
    <select id="fStatus"><option value="">Todos</option></select>
  </div>
  <div class="filter-group">
    <label>Property</label>
    <select id="fProperty"><option value="">Todas</option></select>
  </div>
  <div class="filter-group">
    <label>Periodo</label>
    <select id="fPeriodo"><option value="">Todos</option></select>
  </div>
  <div class="filter-group">
    <label>Tipo</label>
    <select id="fTipo"><option value="">Todos</option></select>
  </div>
  <div class="filter-group">
    <label>Buscar</label>
    <input type="text" id="searchBox" placeholder="Nombre, nº reserva, propiedad…">
  </div>
  <div class="filter-spacer"></div>
  <button class="btn" onclick="resetFilters()">✕ Limpiar</button>
  <button class="btn btn-accent" onclick="exportCSV()">⬇ Exportar CSV</button>
</div>

<!-- TABLE INFO -->
<div class="table-info">
  <span class="table-count" id="tableCount">—</span>
  <span class="table-count" id="tableSort">Click en cabecera para ordenar</span>
</div>

<!-- TABLE -->
<div class="table-wrap">
  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- PAGINATION -->
<div class="pagination" id="pagination"></div>

<script>
// ─── CONFIG ───
const SHEET_ID = '1hi4dWvoqiCD-3k9Yv6sH5KChaYRdRW_dSdBwb9Ryvhw';
const GID = '1035619300';
const PAGE_SIZE = 50;

// ─── STATE ───
let allRows = [], filteredRows = [], headers = [];
let currentPage = 0, sortCol = -1, sortDir = 1;

// Column display config: [index, shortLabel, isNumeric, isStatus, isMoney]
const DISPLAY_COLS = [
  [0,  'Reserva',       false, false, false],
  [3,  'Llegada',       false, false, false],
  [4,  'Salida',        false, false, false],
  [6,  'Huésped',       false, false, false],
  [19, 'Propiedad',     false, false, false],
  [7,  'Hab.',          true,  false, false],
  [8,  'Pers.',         true,  false, false],
  [9,  'Noches',        true,  false, false],
  [12, 'Importe Final', true,  false, true],
  [13, 'Comisión',      true,  false, true],
  [15, 'Estado',        false, true,  false],
  [17, 'Moneda',        false, false, false],
  [20, 'Ciudad',        false, false, false],
  [23, 'Periodo',       false, false, false],
  [24, 'Tipo',          false, false, false],
];

// ─── LOAD DATA ───
function loadData() {
  const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&headers=1`;

  // Method 1: JSONP via script injection (works cross-origin, no auth needed if sheet is accessible)
  window.__gvizCallback = function(resp) {
    if (resp && resp.table) {
      processResponse(resp);
    }
  };

  // Try fetch first (works if same-origin or CORS allowed)
  fetch(base + '&tqx=out:json', { credentials: 'include' })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    })
    .then(text => {
      // Handle both formats: wrapped in callback or raw JSON
      let json;
      if (text.includes('google.visualization.Query.setResponse')) {
        json = text.replace(/^[\s\S]*?google\.visualization\.Query\.setResponse\(/, '').replace(/\);?\s*$/, '');
      } else {
        json = text.replace(/^[^{]*/, '').replace(/[^}]*$/, '');
      }
      processResponse(JSON.parse(json));
    })
    .catch(() => {
      // Fallback: JSONP script tag (bypasses CORS)
      const s = document.createElement('script');
      s.src = base + '&tqx=out:json;responseHandler:__gvizCallback';
      s.onerror = function() {
        document.getElementById('loader').innerHTML = `
          <div style="text-align:center;padding:40px;color:var(--text-muted)">
            <p style="font-size:1.2rem;margin-bottom:12px;color:var(--cancelled)">⚠ No se pudo conectar</p>
            <p>Asegúrate de que la hoja de cálculo está compartida como<br>"Cualquier persona con el enlace puede ver"</p>
            <p style="margin-top:12px"><a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?gid=${GID}" target="_blank">Abrir hoja en Google Sheets ↗</a></p>
          </div>`;
      };
      document.body.appendChild(s);
    });
}

function processResponse(data) {
  headers = data.table.cols.map(c => c.label);
  const types = data.table.cols.map(c => c.type);

  allRows = data.table.rows.map(row => {
    return row.c.map((cell, i) => {
      if (!cell) return '';
      if (types[i] === 'date' || types[i] === 'datetime') {
        return cell.f || '';
      }
      if (cell.f && types[i] === 'number') return cell.v;
      return cell.v != null ? cell.v : '';
    });
  });

  populateFilters();
  applyFilters();
  buildTableHead();
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('liveStatus').textContent = allRows.length.toLocaleString('es') + ' registros cargados';
}

function populateFilters() {
  // Status (col 15)
  const statuses = [...new Set(allRows.map(r => r[15]).filter(Boolean))].sort();
  const selStatus = document.getElementById('fStatus');
  statuses.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; selStatus.appendChild(o); });

  // Property (col 19)
  const props = [...new Set(allRows.map(r => r[19]).filter(Boolean))].sort();
  const selProp = document.getElementById('fProperty');
  props.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p.length > 45 ? p.substring(0,42)+'…' : p; selProp.appendChild(o); });

  // Periodo (col 23)
  const periodos = [...new Set(allRows.map(r => r[23]).filter(Boolean))].sort();
  const selPer = document.getElementById('fPeriodo');
  periodos.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; selPer.appendChild(o); });

  // Tipo (col 24)
  const tipos = [...new Set(allRows.map(r => r[24]).filter(Boolean))].sort();
  const selTipo = document.getElementById('fTipo');
  tipos.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; selTipo.appendChild(o); });
}

// ─── FILTERS ───
document.getElementById('fStatus').addEventListener('change', () => { currentPage=0; applyFilters(); });
document.getElementById('fProperty').addEventListener('change', () => { currentPage=0; applyFilters(); });
document.getElementById('fPeriodo').addEventListener('change', () => { currentPage=0; applyFilters(); });
document.getElementById('fTipo').addEventListener('change', () => { currentPage=0; applyFilters(); });
document.getElementById('searchBox').addEventListener('input', debounce(() => { currentPage=0; applyFilters(); }, 250));

function applyFilters() {
  const st = document.getElementById('fStatus').value;
  const pr = document.getElementById('fProperty').value;
  const pe = document.getElementById('fPeriodo').value;
  const ti = document.getElementById('fTipo').value;
  const q = document.getElementById('searchBox').value.toLowerCase().trim();

  filteredRows = allRows.filter(r => {
    if (st && r[15] !== st) return false;
    if (pr && r[19] !== pr) return false;
    if (pe && r[23] !== pe) return false;
    if (ti && r[24] !== ti) return false;
    if (q) {
      const haystack = [r[0],r[5],r[6],r[19],r[20],r[15],r[23]].join(' ').toLowerCase();
      if (!haystack.includes(q)) return false;
    }
    return true;
  });

  if (sortCol >= 0) doSort();
  updateKPIs();
  renderTable();
}

function resetFilters() {
  document.getElementById('fStatus').value = '';
  document.getElementById('fProperty').value = '';
  document.getElementById('fPeriodo').value = '';
  document.getElementById('fTipo').value = '';
  document.getElementById('searchBox').value = '';
  currentPage = 0;
  applyFilters();
}

// ─── KPIs ───
function updateKPIs() {
  const total = filteredRows.length;
  const ok = filteredRows.filter(r => r[15] === 'OK').length;
  const cancel = filteredRows.filter(r => r[15] === 'CANCELLED' || r[15] === 'Chargeable cancellation').length;
  const noShow = filteredRows.filter(r => r[15] === 'NO_SHOW' || r[15] === 'Chargeable no show').length;
  const finalAmt = filteredRows.reduce((s, r) => s + (parseFloat(r[12]) || 0), 0);
  const commAmt = filteredRows.reduce((s, r) => s + (parseFloat(r[13]) || 0), 0);
  const nights = filteredRows.reduce((s, r) => s + (parseInt(r[9]) || 0), 0);

  document.getElementById('kpiTotal').textContent = total.toLocaleString('es');
  document.getElementById('kpiTotalSub').textContent = `de ${allRows.length.toLocaleString('es')} totales`;
  document.getElementById('kpiOk').textContent = ok.toLocaleString('es');
  document.getElementById('kpiOkSub').textContent = total ? (ok/total*100).toFixed(1) + '% del filtro' : '';
  document.getElementById('kpiCancel').textContent = cancel.toLocaleString('es');
  document.getElementById('kpiCancelSub').textContent = noShow ? `+ ${noShow} No-Show` : '';
  document.getElementById('kpiFinal').textContent = formatMoney(finalAmt);
  document.getElementById('kpiFinalSub').textContent = `Media: ${total ? formatMoney(finalAmt/total) : '0'} /reserva`;
  document.getElementById('kpiComm').textContent = formatMoney(commAmt);
  document.getElementById('kpiCommSub').textContent = finalAmt ? `${(commAmt/finalAmt*100).toFixed(1)}% del importe` : '';
  document.getElementById('kpiNights').textContent = nights.toLocaleString('es');
  document.getElementById('kpiNightsSub').textContent = total ? `Media: ${(nights/total).toFixed(1)} noches/reserva` : '';
}

// ─── TABLE HEAD ───
function buildTableHead() {
  const thead = document.getElementById('thead');
  let tr = '<tr>';
  DISPLAY_COLS.forEach((col, i) => {
    tr += `<th onclick="sortBy(${i})" data-ci="${i}">${col[1]}</th>`;
  });
  tr += '</tr>';
  thead.innerHTML = tr;
}

// ─── SORT ───
function sortBy(displayIndex) {
  if (sortCol === displayIndex) {
    sortDir *= -1;
  } else {
    sortCol = displayIndex;
    sortDir = 1;
  }
  // Update header classes
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted-asc','sorted-desc'));
  const th = document.querySelector(`thead th[data-ci="${displayIndex}"]`);
  th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');

  doSort();
  currentPage = 0;
  renderTable();
}

function doSort() {
  const colDef = DISPLAY_COLS[sortCol];
  const realIdx = colDef[0];
  const isNum = colDef[2];

  filteredRows.sort((a, b) => {
    let va = a[realIdx], vb = b[realIdx];
    if (isNum) {
      va = parseFloat(va) || 0;
      vb = parseFloat(vb) || 0;
    } else {
      va = String(va).toLowerCase();
      vb = String(vb).toLowerCase();
    }
    if (va < vb) return -1 * sortDir;
    if (va > vb) return 1 * sortDir;
    return 0;
  });
}

// ─── TABLE RENDER ───
function renderTable() {
  const tbody = document.getElementById('tbody');
  const start = currentPage * PAGE_SIZE;
  const end = Math.min(start + PAGE_SIZE, filteredRows.length);
  const page = filteredRows.slice(start, end);

  let html = '';
  page.forEach(row => {
    html += '<tr>';
    DISPLAY_COLS.forEach(col => {
      const val = row[col[0]];
      if (col[3]) { // Status column
        html += `<td>${statusBadge(val)}</td>`;
      } else if (col[4]) { // Money
        html += `<td class="num">${val ? parseFloat(val).toLocaleString('es',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—'}</td>`;
      } else if (col[2]) { // Numeric
        html += `<td class="num">${val || '—'}</td>`;
      } else {
        const display = String(val || '—');
        html += `<td title="${display.replace(/"/g,'&quot;')}">${display}</td>`;
      }
    });
    html += '</tr>';
  });
  tbody.innerHTML = html;

  document.getElementById('tableCount').textContent = filteredRows.length === 0
    ? 'Sin resultados'
    : `${start+1}–${end} de ${filteredRows.length.toLocaleString('es')} reservas`;

  renderPagination();
}

function statusBadge(val) {
  if (!val) return '<span class="status-badge">—</span>';
  const v = String(val).toUpperCase();
  let cls = '';
  if (v === 'OK') cls = 'status-ok';
  else if (v === 'CANCELLED' || v.includes('CANCELLATION')) cls = 'status-cancelled';
  else if (v === 'NO_SHOW' || v.includes('NO SHOW')) cls = 'status-no_show';
  else cls = 'status-chargeable';
  return `<span class="status-badge ${cls}">${val}</span>`;
}

// ─── PAGINATION ───
function renderPagination() {
  const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
  const pag = document.getElementById('pagination');
  if (totalPages <= 1) { pag.innerHTML = ''; return; }

  let html = '';
  if (currentPage > 0)
    html += `<button class="page-btn nav" onclick="goPage(${currentPage-1})">‹ Anterior</button>`;

  const start = Math.max(0, currentPage - 3);
  const end = Math.min(totalPages - 1, currentPage + 3);

  if (start > 0) {
    html += `<button class="page-btn" onclick="goPage(0)">1</button>`;
    if (start > 1) html += `<span class="page-info">…</span>`;
  }
  for (let p = start; p <= end; p++) {
    html += `<button class="page-btn${p===currentPage?' active':''}" onclick="goPage(${p})">${p+1}</button>`;
  }
  if (end < totalPages - 1) {
    if (end < totalPages - 2) html += `<span class="page-info">…</span>`;
    html += `<button class="page-btn" onclick="goPage(${totalPages-1})">${totalPages}</button>`;
  }

  if (currentPage < totalPages - 1)
    html += `<button class="page-btn nav" onclick="goPage(${currentPage+1})">Siguiente ›</button>`;

  pag.innerHTML = html;
}

function goPage(p) { currentPage = p; renderTable(); window.scrollTo({top: 260, behavior:'smooth'}); }

// ─── EXPORT CSV ───
function exportCSV() {
  const head = DISPLAY_COLS.map(c => c[1]);
  const csvRows = [head.join(';')];
  filteredRows.forEach(row => {
    const vals = DISPLAY_COLS.map(c => {
      const v = String(row[c[0]] ?? '');
      return '"' + v.replace(/"/g,'""') + '"';
    });
    csvRows.push(vals.join(';'));
  });
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csvRows.join('\n')], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cache_reservas_' + new Date().toISOString().substring(0,10) + '.csv';
  a.click();
}

// ─── UTILS ───
function formatMoney(n) {
  if (Math.abs(n) >= 1000000) return (n/1000000).toLocaleString('es',{maximumFractionDigits:1}) + 'M';
  return n.toLocaleString('es', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function debounce(fn, ms) { let t; return function() { clearTimeout(t); t = setTimeout(fn, ms); }; }

// Handle default gviz wrapper
if (!window.google) window.google = {};
if (!window.google.visualization) window.google.visualization = {};
if (!window.google.visualization.Query) window.google.visualization.Query = {};
window.google.visualization.Query.setResponse = function(resp) {
  if (resp && resp.table) processResponse(resp);
};

// ─── INIT ───
document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
